<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* =========================================
           1. 全局变量
           ========================================= */
        :root {
            /* --- Light Mode --- */
            --bg-color: #f0f4f8; 
            --card-bg: rgba(255, 255, 255, 0.75); 
            --card-border: rgba(0, 60, 150, 0.15); 
            --card-blur: 20px;
            
            --text-main: #1a2b3c; 
            --text-sub: #546e7a;  
            --tech-blue: #0055aa; 
            --accent-glow: rgba(0, 85, 170, 0.15);
            --input-bg: rgba(255, 255, 255, 0.8);
            
            --bubble-bg: rgba(255, 255, 255, 0.9);
            --icon-color: #78909c;

            --ease-smooth: cubic-bezier(0.25, 1, 0.5, 1); 
            --anim-duration: 0.6s;
        }

        /* --- Dark Mode --- */
        body.dark-mode {
            --bg-color: #050a10;
            --card-bg: rgba(10, 15, 25, 0.8); 
            --card-border: rgba(60, 140, 255, 0.2);
            
            --text-main: #ffffff;
            --text-sub: rgba(140, 180, 255, 0.6);
            --tech-blue: #0088ff; 
            --accent-glow: rgba(0, 136, 255, 0.4);
            --input-bg: rgba(20, 30, 45, 0.8);

            --bubble-bg: rgba(20, 30, 45, 0.9);
            --icon-color: #546e7a;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            color: var(--text-main);
            transition: background-color 0.8s ease, color 0.5s ease;
        }

        /* =========================================
           2. 布局与容器
           ========================================= */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 999;
            display: flex; justify-content: center; align-items: center;
            color: var(--tech-blue); font-family: "Courier New", monospace; letter-spacing: 4px;
            font-size: 1.2rem;
            transition: opacity 0.8s ease;
        }

        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
            background: radial-gradient(circle at 50% 50%, #fcfdfe 0%, #dde4ea 100%);
            transition: opacity 0.8s; 
        }
        body.dark-mode #canvas-container {
            background: radial-gradient(circle at 50% 50%, #050a15 0%, #000000 90%) !important;
        }

        .stage {
            position: relative; z-index: 10; width: 100%; height: 100%;
            perspective: 1000px;
        }

        /* =========================================
           3. 左侧：个人信息 (Profile Layer)
           ========================================= */
        .profile-layer {
            position: absolute; 
            /* 默认上移位置 */
            top: 28%; 
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center; width: 400px;
            transition: all var(--anim-duration) var(--ease-smooth);
            z-index: 20; pointer-events: none;
        }
        .profile-layer * { pointer-events: auto; }

        .bio-bubble {
            position: relative; margin: 0 auto 25px auto;
            width: 280px; padding: 15px 20px;
            background: var(--bubble-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            animation: floatBubble 4s ease-in-out infinite;
            transition: all 0.3s;
            /* 初始隐藏，等数据加载 */
            opacity: 0; 
        }
        .bio-bubble.loaded { opacity: 1; }
        
        @keyframes floatBubble {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .bio-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 8px solid transparent; border-right: 8px solid transparent;
            border-top: 8px solid var(--card-border);
        }
        .bio-bubble::before {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; z-index: 1;
            border-left: 7px solid transparent; border-right: 7px solid transparent;
            border-top: 7px solid var(--bubble-bg);
        }

        .bio-text {
            font-size: 0.9rem; color: var(--text-main); line-height: 1.5; margin: 0;
            font-weight: 500;
        }
        .bio-sub { font-size: 0.75rem; color: var(--text-sub); margin-top: 5px; display: block; }

        .avatar-frame {
            width: 120px; height: 120px; margin: 0 auto 15px;
            border-radius: 50%; padding: 3px;
            background: linear-gradient(180deg, var(--tech-blue), rgba(0,0,0,0)); 
            box-shadow: 0 0 50px var(--accent-glow); 
            transition: all var(--anim-duration) var(--ease-smooth);
            position: relative; z-index: 2;
        }
        /* 增加 object-position 确保头像居中剪裁 */
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: transparent; }
        
        .bio-title { 
            font-size: 3rem; font-weight: 800; letter-spacing: -1px; margin: 0 0 15px 0; 
            background: linear-gradient(to bottom, #004488, #0077cc);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: none; transition: all 0.5s; 
        }
        body.dark-mode .bio-title {
            background: linear-gradient(to bottom, #fff, #88aaff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 136, 255, 0.5);
        }

        .social-links { display: flex; justify-content: center; gap: 20px; margin-top: 5px; }
        /* 图标样式：针对 SVG */
        .social-link-item {
            width: 24px; height: 24px; display: inline-block;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: var(--icon-color); /* 控制 SVG fill */
            cursor: pointer;
        }
        .social-link-item svg {
            width: 100%; height: 100%;
            fill: currentColor; /* 让 SVG 跟随父级颜色 */
        }
        .social-link-item:hover {
            color: var(--tech-blue); 
            transform: translateY(-3px) scale(1.2);
            filter: drop-shadow(0 4px 6px var(--accent-glow));
        }

        /* =========================================
           4. 右侧：搜索与列表 (Panel Layer)
           ========================================= */
        .panel-layer {
            position: absolute; bottom: 0; left: 50%; 
            transform: translate(-50%, 0);
            width: 500px; height: 45vh; 
            display: flex; flex-direction: column;
            padding: 0 20px 5vh 20px; box-sizing: border-box;
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            transition: all var(--anim-duration) var(--ease-smooth);
            z-index: 50; pointer-events: auto;
        }

        .search-container {
            flex-shrink: 0; margin-bottom: 20px; position: relative;
            opacity: 0; transform: translateY(20px); 
            transition: all 0.5s ease 0.2s; 
        }
        .search-input {
            width: 100%; padding: 12px 20px 12px 45px;
            border-radius: 30px; border: 1px solid var(--card-border);
            background: var(--input-bg);
            color: var(--text-main); font-size: 0.95rem;
            backdrop-filter: blur(10px); outline: none; box-sizing: border-box;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .search-input:focus { border-color: var(--tech-blue); box-shadow: 0 0 20px var(--accent-glow); }
        .search-icon {
            position: absolute; left: 18px; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; fill: var(--text-sub); transition: fill 0.3s;
        }
        .search-input:focus + .search-icon { fill: var(--tech-blue); }

        .list-container {
            flex: 1; overflow-y: auto; scrollbar-width: none; padding-top: 5px;
        }
        .list-container::-webkit-scrollbar { display: none; }

        .article-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 22px 28px; margin-bottom: 15px; border-radius: 12px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transform-origin: center bottom; transition: all 0.3s;
            animation: slideIn 0.5s ease forwards; opacity: 0;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .article-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--tech-blue); opacity: 0; transition: opacity 0.3s; }
        .article-info h3 { margin: 0 0 6px 0; font-size: 1.1rem; font-weight: 600; color: var(--text-main); transition: color 0.3s; }
        .article-info p { margin: 0; font-size: 0.85rem; color: var(--text-sub); display: flex; align-items: center; gap: 6px; }
        .article-date { font-size: 0.75rem; color: var(--tech-blue); font-family: monospace; opacity: 0.8; }
        .article-card:hover { transform: translateX(10px) scale(1.02); border-color: var(--tech-blue); box-shadow: 0 4px 20px var(--accent-glow); }
        .article-card:hover::before { opacity: 1; }
        .article-card:hover .article-info h3 { color: var(--tech-blue); }

        /* --- 激活状态布局 --- */
        .stage.active .profile-layer {
            left: 8%; transform: translate(-8%, -50%); 
            top: 40%; /* 激活时垂直居中 */
        }
        
        .stage.active .bio-bubble { width: 220px; padding: 12px 15px; margin-bottom: 15px; }
        .stage.active .bio-text { font-size: 0.85rem; }
        .stage.active .avatar-frame { width: 80px; height: 80px; margin-bottom: 10px; }
        .stage.active .bio-title { font-size: 2rem; margin-bottom: 10px; }
        .stage.active .social-links { gap: 15px; }
        .stage.active .social-link-item { width: 20px; height: 20px; }

        .stage.active .panel-layer {
            transform: translate(5%, 0); width: 45%; max-width: 600px; height: 90vh;
            padding-right: 5%; padding-bottom: 5vh;
        }
        .stage.active .search-container { opacity: 1; transform: translateY(0); }

        #theme-toggle {
            position: fixed; top: 30px; right: 30px; width: 44px; height: 44px;
            background: var(--card-bg); border: 1px solid var(--card-border);
            backdrop-filter: blur(10px); border-radius: 50%; cursor: pointer; z-index: 100;
            display: flex; justify-content: center; align-items: center; transition: all 0.3s;
        }
        #theme-toggle:hover { transform: rotate(15deg) scale(1.1); border-color: var(--tech-blue); }
        #theme-toggle svg { width: 20px; height: 20px; fill: var(--tech-blue); }
    </style>
    
    <script type="x-shader/x-vertex" id="vertexShader">
        varying vec3 vNormal;
        void main() {
            vNormal = normalize(normalMatrix * normal);
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    </script>
    <script type="x-shader/x-fragment" id="fragmentShader">
        varying vec3 vNormal;
        uniform vec3 glowColor;
        uniform float intensityMod;
        void main() {
            float intensity = pow(0.6 - dot(vNormal, vec3(0, 0, 1.0)), 3.5);
            gl_FragColor = vec4(glowColor, 1.0) * intensity * intensityMod;
        }
    </script>
</head>
<body>

    <div id="loader">INITIALIZING...</div>
    <div id="canvas-container"></div>

    <button id="theme-toggle" aria-label="Toggle Theme">
        <svg id="icon-sun" viewBox="0 0 24 24" style="display:none;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1z"/></svg>
        <svg id="icon-moon" viewBox="0 0 24 24"><path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" /></svg>
    </button>

    <div class="stage" id="mainStage">
        <div class="profile-layer">
            <div class="bio-bubble" id="bioBubble">
                <p class="bio-text" id="bioTitle"></p>
                <span class="bio-sub" id="bioDesc"></span>
            </div>
            <div class="avatar-frame">
                <img id="avatarImg" src="" class="avatar-img" alt="Avatar">
            </div>
            <h1 class="bio-title" id="profileName"></h1>
            
            <div class="social-links" id="socialLinks"></div>
        </div>

        <div class="panel-layer" id="panelLayer">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search articles...">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </div>
            
            <div class="list-container" id="listContent">
                </div>
        </div>
    </div>

    <script>
        /* =========================================
           PART 0: 数据加载与初始化
           ========================================= */
        let globalConfig = {};
        let allArticles = [];

        async function initApp() {
            try {
                // 1. 加载配置
                const configRes = await fetch('./config.json');
                if(!configRes.ok) throw new Error("Failed to load config.json");
                globalConfig = await configRes.json();
                
                applyConfig(globalConfig);

                // 2. 加载文章 (由于还未编写生成脚本，这里如果失败则给个空数组)
                try {
                    const articlesRes = await fetch('./articles.json');
                    if(articlesRes.ok) {
                        allArticles = await articlesRes.json();
                        renderList(allArticles);
                    } else {
                        console.warn("articles.json not found, waiting for build...");
                        renderList([]); // 空列表
                    }
                } catch (e) {
                    console.log("No articles yet.");
                    renderList([]);
                }

                // 移除 Loading
                setTimeout(() => {
                    const loaderEl = document.getElementById('loader');
                    loaderEl.style.opacity = 0;
                    setTimeout(() => loaderEl.style.display = 'none', 800);
                }, 500);

            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerText = "CONFIG LOAD FAILED";
            }
        }

        function applyConfig(config) {
            // 网站标题
            document.title = config.site_settings.title || "Blog";

            // 个人信息
            const p = config.profile;
            document.getElementById('profileName').textContent = p.name;
            document.getElementById('bioTitle').textContent = p.bio_title;
            document.getElementById('bioDesc').textContent = p.bio_desc;
            document.getElementById('avatarImg').src = p.avatar_path;
            
            // 显示气泡
            document.getElementById('bioBubble').classList.add('loaded');

            // 社交图标
            const socialContainer = document.getElementById('socialLinks');
            socialContainer.innerHTML = '';
            
            if(config.social_links) {
                config.social_links.forEach(link => {
                    if(!link.url) return; // 跳过空链接

                    const a = document.createElement('a');
                    a.href = link.url;
                    a.target = "_blank";
                    a.className = "social-link-item";
                    a.title = link.name;
                    
                    // 动态加载 SVG 内容以支持变色
                    if(link.icon_path) {
                        fetch(link.icon_path)
                            .then(res => res.text())
                            .then(svgText => {
                                a.innerHTML = svgText;
                            })
                            .catch(() => {
                                a.innerText = link.name[0]; // 失败兜底
                            });
                    }
                    socialContainer.appendChild(a);
                });
            }
        }

        /* =========================================
           PART 1: THREE.JS 
           ========================================= */
        let scene, camera, renderer, globeGroup;
        let meshCore, meshLand, meshAtmos, markerMesh, starsBG, starsFG;
        let baseCameraPos = { x: 0, y: 0, z: 22 }; 
        let targetCameraPos = { ...baseCameraPos };
        let isHoveringList = false;
        let targetGlobeRotationY = 0;
        const TEXTURE_OFFSET = 4.712; 
        let isDarkMode = false;

        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0xdde4ea, 0.0008); 
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 0, 22);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            container.appendChild(renderer.domElement);

            globeGroup = new THREE.Group();
            scene.add(globeGroup);

            const globeGeo = new THREE.SphereGeometry(5, 64, 64);
            const globeMat = new THREE.MeshBasicMaterial({ color: 0xffffff }); 
            meshCore = new THREE.Mesh(globeGeo, globeMat);
            globeGroup.add(meshCore);

            const loader = new THREE.TextureLoader();
            const mapTexture = loader.load('./assets/images/earth.jpg');
            
            const landMat = new THREE.MeshBasicMaterial({
                color: 0x004488, alphaMap: mapTexture, transparent: true,
                opacity: 0.7, blending: THREE.NormalBlending, side: THREE.FrontSide
            });
            meshLand = new THREE.Mesh(globeGeo, landMat);
            globeGroup.add(meshLand);

            const atmosGeo = new THREE.SphereGeometry(5.3, 64, 64);
            const atmosMat = new THREE.ShaderMaterial({
                uniforms: { glowColor: { value: new THREE.Color(0x88ccff) }, intensityMod: { value: 0.6 } },
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fragmentShader').textContent,
                blending: THREE.AdditiveBlending, side: THREE.BackSide, transparent: true
            });
            meshAtmos = new THREE.Mesh(atmosGeo, atmosMat);
            globeGroup.add(meshAtmos);

            const markerGeo = new THREE.SphereGeometry(0.1, 16, 16);
            const markerMat = new THREE.MeshBasicMaterial({ color: 0xff3366 });
            markerMesh = new THREE.Mesh(markerGeo, markerMat);
            const markerGlowGeo = new THREE.SphereGeometry(0.25, 16, 16);
            const markerGlowMat = new THREE.MeshBasicMaterial({ color: 0xff3366, transparent: true, opacity: 0.4, blending: THREE.AdditiveBlending });
            markerMesh.add(new THREE.Mesh(markerGlowGeo, markerGlowMat));
            const lineGeo = new THREE.CylinderGeometry(0.02, 0.01, 1, 8);
            lineGeo.translate(0, 0.5, 0); lineGeo.rotateX(Math.PI / 2); 
            const lineMat = new THREE.MeshBasicMaterial({ color: 0xff3366, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending });
            markerMesh.add(new THREE.Mesh(lineGeo, lineMat));
            globeGroup.add(markerMesh);
            markerMesh.visible = false; 

            createStarfield();
            animate();
        }

        function createStarfield() {
            const bgGeo = new THREE.BufferGeometry();
            const bgCount = 2000; 
            const bgPos = new Float32Array(bgCount * 3);
            for(let i=0; i<bgCount*3; i++) bgPos[i] = (Math.random() - 0.5) * 600;
            bgGeo.setAttribute('position', new THREE.BufferAttribute(bgPos, 3));
            starsBG = new THREE.Points(bgGeo, new THREE.PointsMaterial({ size: 0.5, color: 0x8899aa, transparent: true, opacity: 0.6 }));
            scene.add(starsBG);

            const fgGeo = new THREE.BufferGeometry();
            const fgCount = 300; 
            const fgPos = new Float32Array(fgCount * 3);
            for(let i=0; i<fgCount*3; i++) fgPos[i] = (Math.random() - 0.5) * 400;
            fgGeo.setAttribute('position', new THREE.BufferAttribute(fgPos, 3));
            starsFG = new THREE.Points(fgGeo, new THREE.PointsMaterial({ size: 1.2, color: 0x334455, transparent: true, opacity: 0.9 }));
            scene.add(starsFG);
        }

        function focusLocation(lat, lon) {
            const radius = 5; 
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180); 
            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = (radius * Math.sin(phi) * Math.sin(theta));
            const y = (radius * Math.cos(phi));
            markerMesh.position.set(x, y, z);
            markerMesh.lookAt(0, 0, 0); 
            markerMesh.visible = true;
            targetGlobeRotationY = TEXTURE_OFFSET - (lon * Math.PI / 180);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(starsBG) starsBG.rotation.y += 0.0003;
            if(starsFG) starsFG.rotation.y += 0.0007;

            if (globeGroup) {
                if (!isHoveringList) {
                    globeGroup.rotation.y += 0.001;
                    targetGlobeRotationY = globeGroup.rotation.y;
                } else {
                    let current = globeGroup.rotation.y;
                    let target = targetGlobeRotationY;
                    let delta = target - current;
                    while (delta > Math.PI) delta -= Math.PI * 2;
                    while (delta < -Math.PI) delta += Math.PI * 2;
                    globeGroup.rotation.y += delta * 0.05;
                }
                if (markerMesh.visible) {
                    const scale = 1 + Math.sin(Date.now() * 0.008) * 0.2;
                    markerMesh.scale.set(scale, scale, scale);
                }
            }
            camera.position.x += (targetCameraPos.x - camera.position.x) * 0.05;
            camera.position.y += (targetCameraPos.y - camera.position.y) * 0.05;
            camera.position.z += (targetCameraPos.z - camera.position.z) * 0.05;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        /* =========================================
           PART 2: UI Logic
           ========================================= */
        const toggleBtn = document.getElementById('theme-toggle');
        const iconMoon = document.getElementById('icon-moon');
        const iconSun = document.getElementById('icon-sun');

        toggleBtn.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            iconMoon.style.display = isDarkMode ? 'none' : 'block';
            iconSun.style.display = isDarkMode ? 'block' : 'none';
            update3DTheme(isDarkMode);
        });

        function update3DTheme(dark) {
            if (!scene) return;
            scene.fog.color.setHex(dark ? 0x000000 : 0xdde4ea);
            if(meshCore) meshCore.material.color.setHex(dark ? 0x000205 : 0xffffff);
            if(meshLand) {
                meshLand.material.color.setHex(dark ? 0x1E69AA : 0x004488);
                meshLand.material.blending = dark ? THREE.AdditiveBlending : THREE.NormalBlending;
                meshLand.material.opacity = dark ? 0.85 : 0.7;
            }
            if(starsBG && starsFG) {
                const starColor = dark ? 0xffffff : 0x334455;
                starsBG.material.color.setHex(dark ? 0x4466aa : 0x8899aa); 
                starsFG.material.color.setHex(starColor);
            }
            if(meshAtmos) {
                const newColor = dark ? 0x0088ff : 0x88ccff;
                meshAtmos.material.uniforms.glowColor.value.setHex(newColor);
                meshAtmos.material.uniforms.intensityMod.value = dark ? 1.0 : 0.6;
            }
        }

        const panelLayer = document.getElementById('panelLayer');
        const listContent = document.getElementById('listContent');
        const stage = document.getElementById('mainStage');
        const searchInput = document.getElementById('searchInput');

        function renderList(data) {
            listContent.innerHTML = ''; 
            if (data.length === 0) {
                listContent.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:40px;">No articles found.</div>';
                return;
            }
            data.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'article-card';
                div.style.animationDelay = `${index * 0.05}s`;
                div.onmouseenter = () => {
                    isHoveringList = true;
                    if(item.lat && item.lon) focusLocation(item.lat, item.lon);
                };
                
                // SVG icon inline
                const iconSvg = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.7"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
                
                div.innerHTML = `
                    <div class="article-info">
                        <h3>${item.title}</h3>
                        <p>${iconSvg} ${item.location || item.loc || 'Unknown'}</p>
                    </div>
                    <span class="article-date">${item.date}</span>
                `;
                // TODO: 真正的点击跳转
                // div.onclick = () => window.location.href = item.url;
                div.onclick = () => {
                    // 跳转到 post.html，并带上文件名参数
                    // 例如：post.html?post=mamba_intro.md
                    window.location.href = `post.html?post=${item.filename}`;
                };
                
                listContent.appendChild(div);
            });
        }

        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = allArticles.filter(item => 
                (item.title && item.title.toLowerCase().includes(keyword)) || 
                (item.location && item.location.toLowerCase().includes(keyword))
            );
            renderList(filtered);
        });

        /* =========================================
           交互核心：焦点锁定 + 强回归
           ========================================= */
        const ANIMATION_DURATION = 600; 
        let isReturning = false; 
        let isMouseOverPanel = false;

        function resetView() {
            stage.classList.remove('active');
            targetCameraPos = { ...baseCameraPos };
            isHoveringList = false;
            markerMesh.visible = false; 
            
            isReturning = true;
            setTimeout(() => { isReturning = false; }, ANIMATION_DURATION);
        }

        panelLayer.addEventListener('mouseenter', () => {
            isMouseOverPanel = true;
            if (isReturning) return;
            stage.classList.add('active');
            targetCameraPos = { x: 5, y: 0, z: 24 };
        });

        panelLayer.addEventListener('mouseleave', () => {
            isMouseOverPanel = false;
            // 焦点锁定
            if (document.activeElement === searchInput) return;

            resetView();
            searchInput.blur(); 
        });

        searchInput.addEventListener('blur', () => {
            if (!isMouseOverPanel) {
                resetView();
            }
        });

        // 启动！
        initThreeJS();
        initApp();

    </script>
</body>
</html>